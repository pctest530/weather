<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å£æ¹–é„‰æ°£è±¡èˆ‡å¸¸ç”¨é€£çµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      background: #eef7ff;
      font-family: "Microsoft JhengHei", sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #0d6efd;
      font-weight: 700;
    }
    .btn-link-custom {
      width: 100%;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
    }
    .accordion-button:not(.collapsed) {
      color: #0d6efd;
      background-color: #e7f1ff;
      font-weight: 600;
    }
    pre {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h1>ğŸŒ¤ï¸ å£æ¹–é„‰æ°£è±¡èˆ‡å¸¸ç”¨é€£çµ</h1>

  <div class="accordion mb-4" id="mainAccordion">

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingWeather">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWeather" aria-expanded="false" aria-controls="collapseWeather">
          ğŸ“ å£æ¹–é„‰ 36 å°æ™‚å¤©æ°£
        </button>
      </h2>
      <div id="collapseWeather" class="accordion-collapse collapse" aria-labelledby="headingWeather" data-bs-parent="#mainAccordion">
        <div class="accordion-body bg-white rounded shadow-sm">
          <div id="weather">
            <p>è³‡æ–™è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingTyphoon">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTyphoon" aria-expanded="false" aria-controls="collapseTyphoon">
          ğŸŒ€ ç›®å‰é¢±é¢¨è³‡è¨Š
        </button>
      </h2>
      <div id="collapseTyphoon" class="accordion-collapse collapse" aria-labelledby="headingTyphoon" data-bs-parent="#mainAccordion">
        <div class="accordion-body bg-white rounded shadow-sm" style="white-space: pre-wrap;">
          <div id="typhoonOutput">
            <p>è³‡æ–™è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingEarthquake">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEarthquake" aria-expanded="false" aria-controls="collapseEarthquake">
          ğŸ“¡ ä¸­å¤®æ°£è±¡å±€åœ°éœ‡é€Ÿå ±
        </button>
      </h2>
      <div id="collapseEarthquake" class="accordion-collapse collapse" aria-labelledby="headingEarthquake" data-bs-parent="#mainAccordion">
        <div class="accordion-body bg-white rounded shadow-sm">
          <h5>ğŸ“¢ é¡¯è‘—æœ‰æ„Ÿåœ°éœ‡</h5>
          <div id="main-list">è³‡æ–™è¼‰å…¥ä¸­...</div>
          <h5 class="mt-4">ğŸ“Œ å°å€åŸŸæœ‰æ„Ÿåœ°éœ‡</h5>
          <div id="local-list">è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>

    <div class="accordion-item">
      <h2 class="accordion-header" id="headingTide">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTide" aria-expanded="false" aria-controls="collapseTide">
          ğŸŒŠ å£æ¹–é„‰æ½®æ±é å ±
        </button>
      </h2>
      <div id="collapseTide" class="accordion-collapse collapse" aria-labelledby="headingTide" data-bs-parent="#mainAccordion">
        <div class="accordion-body bg-white rounded shadow-sm">
          <div id="tide-content">
            <p id="loading">è³‡æ–™è¼‰å…¥ä¸­...</p>
            <table id="tideTable" class="table table-bordered table-hover" style="display:none;">
              <thead class="table-primary">
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>æ½®æ±é¡å‹</th>
                  <th>æ™‚é–“</th>
                  <th>æ½®é«˜ï¼ˆå…¬åˆ†ï¼‰</th>
                </tr>
              </thead>
              <tbody id="tideTableBody"></tbody>
            </table>
            <button id="toggleBtn" class="btn btn-primary" style="display:none;">é¡¯ç¤ºæ›´å¤šæ—¥æœŸ</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <h3 class="mb-3 text-center">ğŸ”— å¸¸ç”¨é€£çµ</h3>
  <div class="d-grid gap-2 col-12 col-md-6 mx-auto mb-5">
    <a href="https://yliflood.yunlin.gov.tw/cameralist/#" target="_blank" class="btn btn-primary btn-link-custom">éŸŒæ€§é˜²ç½</a>
    <a href="https://www.cwa.gov.tw/V8/C/" target="_blank" class="btn btn-primary btn-link-custom">æ°£è±¡ç½²å®˜ç¶²</a>
    <a href="https://eocdss.ncdr.nat.gov.tw/web" target="_blank" class="btn btn-primary btn-link-custom">ç½å®³æƒ…è³‡ç¶²</a>
    <a href="https://lamp.yunlin.gov.tw/slyunlin/Default.aspx" target="_blank" class="btn btn-primary btn-link-custom">é›²æ—è·¯ç‡ˆ</a>
    <a href="https://pctest530.github.io/kouhu/" target="_blank" class="btn btn-primary btn-link-custom">å£æ¹–è³‡è¨Š</a>
    <a href="https://service.taipower.com.tw/nds/ndsWeb/ndft112.aspx" target="_blank" class="btn btn-primary btn-link-custom">å°ç£é›»åŠ›</a>
    <a href="https://service.taipower.com.tw/branch/d120/xcnotice?xsmsid=0M242581310910082112" target="_blank" class="btn btn-primary btn-link-custom">åœé›»æŸ¥è©¢</a>
    <a href="https://web.water.gov.tw/wateroff/" target="_blank" class="btn btn-primary btn-link-custom">è‡ªä¾†æ°´</a>
    <a href="https://pwd.yunlin.gov.tw/YLPub/" target="_blank" class="btn btn-primary btn-link-custom">ç®¡ç·šæŒ–æ˜</a>
    <a href="https://www.dgpa.gov.tw/typh/daily/nds.html" target="_blank" class="btn btn-primary btn-link-custom">åœç­èª²æŸ¥è©¢</a>
    
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // è«‹å°‡ 'your_liff_id_here' æ›¿æ›ç‚ºæ‚¨åœ¨ LINE é–‹ç™¼è€…å¾Œå°å–å¾—çš„ LIFF ID
    // æ‚¨çš„ LIFF ID
    const LIFF_ID = '2007860540-Mj26ZmJR';
    
    // åˆå§‹åŒ– LIFF
    window.onload = function() {
        liff.init({
            liffId: LIFF_ID
        }).then(() => {
            console.log('LIFF init successfully.');
        }).catch((err) => {
            console.error("LIFF initialization failed", err);
        });
        
        // é é¢è¼‰å…¥æ™‚ï¼Œç›´æ¥åŸ·è¡ŒåŸæœ¬çš„ API å‘¼å«åŠŸèƒ½
        loadAllData();
    };

    // ---------------- æ•´åˆ LIFF å¾Œï¼Œæ‰€æœ‰åŸæœ¬çš„ JavaScript åŠŸèƒ½ ----------------

    const apiKey = "CWA-FA9ADF96-A21B-4D5D-9E9D-839DBF75AF71";

    async function loadAllData() {
      // è¼‰å…¥å¤©æ°£
      loadWeather();
      // è¼‰å…¥é¢±é¢¨
      loadTyphoon();
      // è¼‰å…¥åœ°éœ‡
      loadEarthquake();
      // è¼‰å…¥æ½®æ±
      loadTideForecast();
    }

    // ---------------- å£æ¹–é„‰ 36 å°æ™‚å¤©æ°£ ----------------
    function loadWeather() {
      const weatherDiv = document.getElementById("weather");
      const iconMap = {
        'æ™´': 'â˜€ï¸', 'å¤šé›²': 'â›…', 'é™°': 'â˜ï¸',
        'å°é›¨': 'ğŸŒ§ï¸','é™£é›¨':'ğŸŒ¦ï¸','é›·é™£é›¨':'â›ˆï¸',
        'é›¨':'ğŸŒ§ï¸','çŸ­æš«é™£é›¨':'ğŸŒ¦ï¸','å±€éƒ¨é›¨':'ğŸŒ¦ï¸',
        'é›·':'âš¡'
      };
      fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${apiKey}&locationName=é›²æ—ç¸£`)
        .then(res => res.json())
        .then(json => {
          const loc = json.records.location[0];
          const t = loc.weatherElement.find(e => e.elementName == 'Wx').time;
          const pop = loc.weatherElement.find(e => e.elementName == 'PoP').time;
          const minT = loc.weatherElement.find(e => e.elementName == 'MinT').time;
          const maxT = loc.weatherElement.find(e => e.elementName == 'MaxT').time;

          const labels = ['ä»Šæ—©', 'ä»Šæ™š', 'æ˜æ—©'];
          let html = '';

          for (let i = 0; i < 3; i++) {
            const w = t[i].parameter.parameterName;
            const p = pop[i].parameter.parameterName;
            const lT = minT[i].parameter.parameterName;
            const hT = maxT[i].parameter.parameterName;
            const icon = Object.keys(iconMap).find(k => w.includes(k)) ? iconMap[Object.keys(iconMap).find(k => w.includes(k))] : 'â“';

            const st = t[i].startTime.slice(5, 16).replace(' ', ' ').split(' ')[0];
            const et = t[i].endTime.slice(5, 16).split(' ')[1];
            html += `
              <div class="mb-3 p-3 border rounded shadow-sm">
                <div><strong>${labels[i]} (${st}~${et})</strong> ${icon}</div>
                <div>å¤©æ°£ï¼š${w}</div>
                <div>é™é›¨æ©Ÿç‡ï¼š${p}%</div>
                <div>æ°£æº«ç¯„åœï¼š${lT}Â°C ~ ${hT}Â°C</div>
              </div>`;
          }
          weatherDiv.innerHTML = html;
        })
        .catch(e => {
          weatherDiv.innerHTML = '<p class="text-danger">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
          console.error(e);
        });
    }

    // ---------------- ç›®å‰é¢±é¢¨è³‡è¨Š ----------------
    function loadTyphoon() {
      const typhoonOutput = document.getElementById("typhoonOutput");
      fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/W-C0034-005?Authorization=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          const cyclones = data.records?.tropicalCyclones?.tropicalCyclone || [];
          typhoonOutput.innerHTML = "";

          if (cyclones.length === 0) {
            typhoonOutput.innerText = "ğŸ“­ ç›®å‰ç„¡æ´»å‹•é¢±é¢¨";
            return;
          }

          const latestFixTime = cyclones[0].analysisData?.fix?.[0]?.fixTime || "";
          if (latestFixTime) {
            const d = new Date(latestFixTime);
            typhoonOutput.innerText = `ğŸ“… è³‡æ–™æ›´æ–°æ™‚é–“ï¼š${d.toLocaleString("zh-TW")}\n\n`;
          }

          cyclones.forEach((cyclone, idx) => {
            const name = cyclone.cwaTyphoonName || cyclone.typhoonName || "æœªå‘½å";
            const analysis = cyclone.analysisData?.fix?.[0];
            const forecastList = cyclone.forecastData?.fix || [];

            let content = `ğŸŒªï¸ ç¬¬ ${idx + 1} è™Ÿé¢±é¢¨ï¼š${name}\n\n`;

            if (analysis) {
              content += `ğŸ•’ æœ€æ–°åˆ†ææ™‚é–“ï¼š${analysis.fixTime}\n`;
              content += `ğŸ“ åº§æ¨™ï¼š${analysis.coordinate}\n`;
              content += `ğŸ’¨ æœ€å¤§é¢¨é€Ÿï¼š${analysis.maxWindSpeed} m/s\n`;
              content += `ğŸ¯ æ–¹å‘ï¼š${analysis.movingDirection}\n`;
              content += `ğŸ§­ é€Ÿåº¦ï¼š${analysis.movingSpeed} km/h\n`;
              content += `ğŸˆ ä¸­å¿ƒæ°£å£“ï¼š${analysis.pressure} hPa\n`;
              content += `ğŸŒ€ é™£é¢¨ï¼š${analysis.maxGustSpeed} m/s\n`;
              const movement = analysis.movingPrediction?.find(p => p.lang === "zh-hant");
              if (movement) content += `ğŸ“¡ ç§»å‹•æè¿°ï¼š${movement.value}\n`;
              content += `\n`;
            }

            if (forecastList.length > 0) {
              content += "é æ¸¬è·¯å¾‘ï¼š\n";
              forecastList.forEach(f => {
                content += `â± ${f.tau} å°æ™‚å¾Œ â†’ åº§æ¨™ï¼š${f.coordinate}ã€é¢¨é€Ÿï¼š${f.maxWindSpeed} m/sã€æ°£å£“ï¼š${f.pressure} hPaã€æ–¹å‘ï¼š${f.movingDirection}ã€é€Ÿåº¦ï¼š${f.movingSpeed} km/h\n`;
                if (f.radiusOf70PercentProbability) {
                  content += `ã€€ã€€ğŸ“ 70% æ©Ÿç‡åŠå¾‘ï¼š${f.radiusOf70PercentProbability} km\n`;
                }
                if (f.circleOf15Ms?.radius) {
                  content += `ã€€ã€€ğŸŒ¬ 15m/s é¢¨é€ŸåŠå¾‘ï¼š${f.circleOf15Ms.radius} km\n`;
                }
                const state = f.stateTransfers?.find(p => p.lang === "zh-hant");
                if (state) {
                  content += `ã€€ã€€ğŸ§¾ é æ¸¬ç‹€æ…‹ï¼š${state.value}\n`;
                }
              });
            }

            typhoonOutput.innerText += content + "\n\n";
          });
        })
        .catch(err => {
          typhoonOutput.innerText = "âŒ è¼‰å…¥éŒ¯èª¤ï¼š" + err.message;
          console.error(err);
        });
    }


    // ---------------- ä¸­å¤®æ°£è±¡å±€åœ°éœ‡é€Ÿå ± ----------------
    function loadEarthquake() {
      const apiEarthquakeMainUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${apiKey}&limit=20`;
      const apiEarthquakeLocalUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0016-001?Authorization=${apiKey}&limit=20`;

      function formatTime(tstr) {
        const d = new Date(tstr);
        if (isNaN(d)) return "æœªçŸ¥æ™‚é–“";
        const hours = d.getHours();
        const ampm = hours < 12 ? "ä¸Šåˆ" : "ä¸‹åˆ";
        const hour12 = hours % 12 || 12;
        const minutes = d.getMinutes().toString().padStart(2, '0');
        return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${ampm} ${hour12}:${minutes}`;
      }

      function renderQuakes(data, targetId, hasLink = false) {
        let eqs = data.records?.Earthquake;
        if (!eqs || eqs.length === 0) {
          document.getElementById(targetId).innerText = "ç›®å‰æ²’æœ‰è³‡æ–™";
          return;
        }
        eqs.sort((a, b) => {
          const ta = new Date(a.EarthquakeInfo?.OriginTime || 0);
          const tb = new Date(b.EarthquakeInfo?.OriginTime || 0);
          return tb - ta;
        });

        let html = "";
        eqs.slice(0, 5).forEach(eq => {
          const info = eq.EarthquakeInfo || {};
          const loc = info.Epicenter?.Location || "æœªçŸ¥åœ°é»";
          const mag = info.EarthquakeMagnitude?.MagnitudeValue ?? "æœªçŸ¥";
          const depth = info.FocalDepth ?? "æœªçŸ¥";
          const time = formatTime(info.OriginTime || "");

          html += `<div class="mb-3 p-3 border rounded shadow-sm bg-light">
            <div><strong>éœ‡å¤®ï¼š</strong>${loc}</div>
            <div>ğŸ•’ æ™‚é–“ï¼š${time}</div>
            <div>ğŸ“ è¦æ¨¡ï¼š${mag}ã€€ğŸ’§ æ·±åº¦ï¼š${depth} å…¬é‡Œ</div>`;
          if (hasLink && eq.Web) {
            html += `<div><a href="${eq.Web}" target="_blank" rel="noopener">è©³ç´°å ±å‘Šé€£çµ</a></div>`;
          }
          html += `</div>`;
        });

        document.getElementById(targetId).innerHTML = html;
      }

      fetch(apiEarthquakeMainUrl)
        .then(res => res.json())
        .then(data => renderQuakes(data, "main-list", true))
        .catch(e => {
          document.getElementById('main-list').innerText = "âŒ è¼‰å…¥å¤±æ•—";
          console.error(e);
        });

      fetch(apiEarthquakeLocalUrl)
        .then(res => res.json())
        .then(data => renderQuakes(data, "local-list"))
        .catch(e => {
          document.getElementById('local-list').innerText = "âŒ è¼‰å…¥å¤±æ•—";
          console.error(e);
        });
    }

    // ---------------- å£æ¹–é„‰æ½®æ±é å ± ----------------
    function loadTideForecast() {
      const API_TIDE_URL = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-A0021-001?Authorization=${apiKey}`;
      const LOCATION_ID = "10009190"; // å£æ¹–é„‰

      let allDailyData = [];
      let showingAll = false;

      function formatTimeTide(dateTimeStr) {
        const d = new Date(dateTimeStr);
        let hours = d.getHours();
        const minutes = d.getMinutes().toString().padStart(2, '0');
        const period = hours < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ';
        hours = hours % 12 || 12;
        return `${period} ${hours.toString().padStart(2, '0')}:${minutes}`;
      }

      function getTodayString() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function renderTable(dailyData) {
        const tbody = document.getElementById("tideTableBody");
        tbody.innerHTML = "";
        dailyData.forEach(day => {
          day.Time.forEach(tide => {
            const date = day.Date;
            let type = tide.Tide === "ä¹¾æ½®" ? "é€€æ½®" : tide.Tide;
            const time = formatTimeTide(tide.DateTime);
            const height = tide.TideHeights?.AboveChartDatum ?? "-";

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${date}</td>
              <td>${type}</td>
              <td>${time}</td>
              <td>${height}</td>
            `;
            tbody.appendChild(tr);
          });
        });
      }

      async function loadTideData() {
        try {
          const res = await fetch(API_TIDE_URL);
          const json = await res.json();

          if (json.success !== "true" && json.Success !== "true") {
            throw new Error("API å›å‚³å¤±æ•—");
          }

          const forecasts = json.records.TideForecasts;
          const locationData = forecasts.find(loc => loc.Location.LocationId === LOCATION_ID);

          if (!locationData) {
            document.getElementById('loading').innerText = "æ‰¾ä¸åˆ°å£æ¹–é„‰æ½®æ±é å ±è³‡æ–™";
            return;
          }

          allDailyData = locationData.Location.TimePeriods.Daily;

          // æ—¥æœŸæ’åºç”±è¿‘åˆ°é 
          allDailyData.sort((a, b) => a.Date.localeCompare(b.Date));

          const todayStr = getTodayString();
          const todayData = allDailyData.filter(d => d.Date === todayStr);

          if (todayData.length === 0) {
            document.getElementById('loading').innerText = "ä»Šæ—¥ç„¡æ½®æ±è³‡æ–™";
          } else {
            renderTable(todayData);
            document.getElementById('loading').style.display = "none";
            document.getElementById('tideTable').style.display = "table";
            document.getElementById('toggleBtn').style.display = "block";
          }

        } catch (error) {
          document.getElementById('loading').innerText = "âŒ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
          console.error(error);
        }
      }

      document.getElementById("toggleBtn").addEventListener("click", () => {
        const btn = document.getElementById("toggleBtn");
        if (showingAll) {
          // é¡¯ç¤ºç•¶å¤©
          const todayStr = getTodayString();
          const todayData = allDailyData.filter(d => d.Date === todayStr);
          renderTable(todayData);
          btn.textContent = "é¡¯ç¤ºæ›´å¤šæ—¥æœŸ";
          showingAll = false;
        } else {
          // é¡¯ç¤ºå…¨éƒ¨
          renderTable(allDailyData);
          btn.textContent = "åªé¡¯ç¤ºä»Šæ—¥";
          showingAll = true;
        }
      });

      loadTideData();
    }
  </script>
</body>
</html>


