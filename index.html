<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¤©æ°£ãƒ»åœ°éœ‡ãƒ»é¢±é¢¨è³‡è¨Šç¸½è¦½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #eef7ff; padding: 2em; }
    .weather-box, .item, .typhoon-block {
      background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    .btn-group { margin-bottom: 20px; }
    .stage { font-size: 1.1rem; margin-bottom: 10px; }
    .forecast-content {
      background: #f4f8fc; padding: 0.5em 1em; border-left: 4px solid #0077cc;
      margin-top: 0.5em; border-radius: 4px;
    }
    pre { background: #f9f9f9; padding: 1em; border-radius: 6px; white-space: pre-wrap; }
    summary { font-weight: bold; cursor: pointer; color: #0077cc; margin-top: 1em; }
    details[open] summary::after { content: " ğŸ”½"; }
    details summary::after { content: " â–¶"; }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="mb-3">ğŸŒ é›²æ—å£æ¹–åœ°å€å³æ™‚è³‡è¨Š</h2>

    <div class="btn-group mb-4">
      <button class="btn btn-primary" onclick="showTab('weather')">ğŸ“ å¤©æ°£é å ±</button>
      <button class="btn btn-danger" onclick="showTab('earthquake')">ğŸ“¡ åœ°éœ‡é€Ÿå ±</button>
      <button class="btn btn-info" onclick="showTab('typhoon')">ğŸŒ€ é¢±é¢¨è³‡è¨Š</button>
    </div>

    <!-- å¤©æ°£ -->
    <div id="weather" class="tab-content">
      <h4>ğŸ“ å£æ¹–é„‰ 36 å°æ™‚å¤©æ°£ï¼ˆè³‡æ–™ç”±ä¸­å¤®æ°£è±¡ç½²ï¼‰</h4>
      <div id="weatherData">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- åœ°éœ‡ -->
    <div id="earthquake" class="tab-content" style="display:none">
      <h4>ğŸ“¡ ä¸­å¤®æ°£è±¡å±€åœ°éœ‡é€Ÿå ±</h4>
      <div id="earthquakeData">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- é¢±é¢¨ -->
    <div id="typhoon" class="tab-content" style="display:none">
      <h4>ğŸŒ€ ç›®å‰é¢±é¢¨è³‡è¨Š</h4>
      <div id="updateTime">è³‡æ–™è¼‰å…¥ä¸­...</div>
      <div id="typhoonData">è³‡æ–™è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <script>
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(div => div.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
    }

    const iconMap = {
      'æ™´': 'â˜€ï¸', 'å¤šé›²': 'â›…', 'é™°': 'â˜ï¸',
      'å°é›¨': 'ğŸŒ§ï¸','é™£é›¨':'ğŸŒ¦ï¸','é›·é™£é›¨':'â›ˆï¸',
      'é›¨':'ğŸŒ§ï¸','çŸ­æš«é™£é›¨':'ğŸŒ¦ï¸','å±€éƒ¨é›¨':'ğŸŒ¦ï¸','é›·':'âš¡'
    };

    const apiKey = 'CWA-FA9ADF96-A21B-4D5D-9E9D-839DBF75AF71';

    // å¤©æ°£è³‡æ–™
    fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${apiKey}&locationName=é›²æ—ç¸£`)
      .then(res => res.json())
      .then(json => {
        const loc = json.records.location[0];
        const t = loc.weatherElement.find(e => e.elementName === 'Wx').time;
        const pop = loc.weatherElement.find(e => e.elementName === 'PoP').time;
        const minT = loc.weatherElement.find(e => e.elementName === 'MinT').time;
        const maxT = loc.weatherElement.find(e => e.elementName === 'MaxT').time;
        const labels = ['ä»Šæ—©', 'ä»Šæ™š', 'æ˜æ—©'];
        let html = '';

        for (let i = 0; i < 3; i++) {
          const w = t[i].parameter.parameterName;
          const icon = Object.keys(iconMap).find(k => w.includes(k)) ? iconMap[Object.keys(iconMap).find(k => w.includes(k))] : 'â“';
          const p = pop[i].parameter.parameterName;
          const lT = minT[i].parameter.parameterName;
          const hT = maxT[i].parameter.parameterName;
          const st = t[i].startTime.slice(5,16).split(' ')[0];
          const et = t[i].endTime.slice(5,16).split(' ')[1];

          html += `
            <div class="weather-box">
              <div class="stage"><strong>${labels[i]} (${st}~${et})</strong> ${icon}</div>
              <div>å¤©æ°£ï¼š${w}</div>
              <div>é™é›¨æ©Ÿç‡ï¼š${p}%</div>
              <div>æ°£æº«ç¯„åœï¼š${lT}Â°C ~ ${hT}Â°C</div>
            </div>`;
        }

        document.getElementById('weatherData').innerHTML = html;
      });

    // åœ°éœ‡è³‡æ–™
    fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${apiKey}&limit=5`)
      .then(res => res.json())
      .then(data => {
        const eqs = data.records?.Earthquake || [];
        if (eqs.length === 0) return document.getElementById('earthquakeData').innerText = "ç›®å‰æ²’æœ‰åœ°éœ‡è³‡æ–™";
        let html = '';
        eqs.forEach(eq => {
          const info = eq.EarthquakeInfo || {};
          const loc = info.Epicenter?.Location || "æœªçŸ¥åœ°é»";
          const mag = info.EarthquakeMagnitude?.MagnitudeValue ?? "æœªçŸ¥";
          const depth = info.FocalDepth ?? "æœªçŸ¥";
          const timeStr = new Date(info.OriginTime).toLocaleString();

          html += `<div class="item">
            <div><strong>éœ‡å¤®ï¼š</strong>${loc}</div>
            <div>ğŸ•’ æ™‚é–“ï¼š${timeStr}</div>
            <div>ğŸ“ è¦æ¨¡ï¼š${mag}ã€€ğŸ’§ æ·±åº¦ï¼š${depth} å…¬é‡Œ</div>
            <div><a href="${eq.Web}" target="_blank">è©³ç´°å ±å‘Š</a></div>
          </div>`;
        });

        document.getElementById('earthquakeData').innerHTML = html;
      });

    // é¢±é¢¨è³‡æ–™
    fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/W-C0034-005?Authorization=${apiKey}`)
      .then(res => res.json())
      .then(data => {
        const cyclones = data.records?.tropicalCyclones?.tropicalCyclone || [];
        const output = document.getElementById("typhoonData");
        const updateEl = document.getElementById("updateTime");
        output.innerHTML = "";

        if (cyclones.length === 0) {
          output.innerText = "ğŸ“­ ç›®å‰ç„¡æ´»å‹•é¢±é¢¨";
          updateEl.innerText = "";
          return;
        }

        const latestFixTime = cyclones[0].analysisData?.fix?.[0]?.fixTime || "";
        if (latestFixTime) updateEl.innerText = `ğŸ“… è³‡æ–™æ›´æ–°æ™‚é–“ï¼š${new Date(latestFixTime).toLocaleString("zh-TW")}`;

        cyclones.forEach((cyclone, idx) => {
          const name = cyclone.cwaTyphoonName || cyclone.typhoonName || "æœªå‘½å";
          const analysis = cyclone.analysisData?.fix?.[0];
          const forecastList = cyclone.forecastData?.fix || [];

          const block = document.createElement("div");
          block.className = "typhoon-block";

          let content = `ğŸŒªï¸ ç¬¬ ${idx + 1} è™Ÿé¢±é¢¨ï¼š${name}\n\n`;
          if (analysis) {
            content += `ğŸ•’ æœ€æ–°åˆ†ææ™‚é–“ï¼š${analysis.fixTime}\n`;
            content += `ğŸ“ åº§æ¨™ï¼š${analysis.coordinate}\n`;
            content += `ğŸ’¨ æœ€å¤§é¢¨é€Ÿï¼š${analysis.maxWindSpeed} m/s\n`;
            content += `ğŸ¯ æ–¹å‘ï¼š${analysis.movingDirection}\n`;
            content += `ğŸ§­ é€Ÿåº¦ï¼š${analysis.movingSpeed} km/h\n`;
            content += `ğŸˆ ä¸­å¿ƒæ°£å£“ï¼š${analysis.pressure} hPa\n`;
            content += `ğŸŒ€ é™£é¢¨ï¼š${analysis.maxGustSpeed} m/s\n`;
            const movement = analysis.movingPrediction?.find(p => p.lang === "zh-hant");
            if (movement) content += `ğŸ“¡ ç§»å‹•æè¿°ï¼š${movement.value}\n\n`;
          }

          const pre = document.createElement("pre");
          pre.innerText = content;
          block.appendChild(pre);

          if (forecastList.length > 0) {
            const details = document.createElement("details");
            const summary = document.createElement("summary");
            summary.textContent = "é æ¸¬è·¯å¾‘ï¼ˆé»æˆ‘å±•é–‹ / æ”¶åˆï¼‰";
            details.appendChild(summary);

            const forecastDiv = document.createElement("div");
            forecastDiv.className = "forecast-content";

            forecastList.forEach(f => {
              let fLine = `â± ${f.tau} å°æ™‚å¾Œ â†’ åº§æ¨™ï¼š${f.coordinate}ã€é¢¨é€Ÿï¼š${f.maxWindSpeed} m/sã€æ°£å£“ï¼š${f.pressure} hPaã€æ–¹å‘ï¼š${f.movingDirection}ã€é€Ÿåº¦ï¼š${f.movingSpeed} km/h\n`;
              if (f.radiusOf70PercentProbability) fLine += `ğŸ“ 70% æ©Ÿç‡åŠå¾‘ï¼š${f.radiusOf70PercentProbability} km\n`;
              if (f.circleOf15Ms?.radius) fLine += `ğŸŒ¬ 15m/s é¢¨é€ŸåŠå¾‘ï¼š${f.circleOf15Ms.radius} km\n`;
              const state = f.stateTransfers?.find(p => p.lang === "zh-hant");
              if (state) fLine += `ğŸ§¾ é æ¸¬ç‹€æ…‹ï¼š${state.value}\n`;
              forecastDiv.appendChild(document.createTextNode(fLine));
              forecastDiv.appendChild(document.createElement("br"));
            });

            details.appendChild(forecastDiv);
            block.appendChild(details);
          }

          output.appendChild(block);
        });
      });
  </script>
</body>
</html>
