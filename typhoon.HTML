<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸŒ€ æ°£è±¡å±€é¢±é¢¨è³‡æ–™ï¼ˆæ”¶åˆé æ¸¬ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #eef6ff;
      padding: 2em;
      color: #222;
    }
    h1 {
      color: #0066cc;
    }
    .typhoon-block {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 2em;
    }
    pre {
      background: #f9f9f9;
      padding: 1em;
      border-radius: 6px;
      white-space: pre-wrap;
    }
    .update-time {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 1em;
    }
    summary {
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      color: #0077cc;
      margin-top: 1em;
    }
    details[open] summary::after {
      content: " ğŸ”½";
    }
    details summary::after {
      content: " â–¶";
    }
    .forecast-content {
      background: #f4f8fc;
      padding: 0.5em 1em;
      border-left: 4px solid #0077cc;
      margin-top: 0.5em;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ€ ç›®å‰é¢±é¢¨è³‡è¨Š(è³‡æ–™ç”±æ°£è±¡ç½²)</h1>
  <div class="update-time" id="updateTime">è³‡æ–™è¼‰å…¥ä¸­...</div>
  <div id="output">è³‡æ–™è¼‰å…¥ä¸­...</div>

  <script>
    const apiKey = "CWA-FA9ADF96-A21B-4D5D-9E9D-839DBF75AF71";
    const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/W-C0034-005?Authorization=${apiKey}`;

    fetch(url)
      .then((res) => res.json())
      .then((data) => {
        const cyclones = data.records?.tropicalCyclones?.tropicalCyclone || [];
        const output = document.getElementById("output");
        const updateEl = document.getElementById("updateTime");
        output.innerHTML = "";

        if (cyclones.length === 0) {
          output.innerText = "ğŸ“­ ç›®å‰ç„¡æ´»å‹•é¢±é¢¨";
          updateEl.innerText = "";
          return;
        }

        const latestFixTime = cyclones[0].analysisData?.fix?.[0]?.fixTime || "";
        if (latestFixTime) {
          const d = new Date(latestFixTime);
          updateEl.innerText = `ğŸ“… è³‡æ–™æ›´æ–°æ™‚é–“ï¼š${d.toLocaleString("zh-TW")}`;
        }

        cyclones.forEach((cyclone, idx) => {
          const name = cyclone.cwaTyphoonName || cyclone.typhoonName || "æœªå‘½å";
          const analysis = cyclone.analysisData?.fix?.[0];
          const forecastList = cyclone.forecastData?.fix || [];

          const block = document.createElement("div");
          block.className = "typhoon-block";

          let content = `ğŸŒªï¸ ç¬¬ ${idx + 1} è™Ÿé¢±é¢¨ï¼š${name}\n\n`;

          if (analysis) {
            content += `ğŸ•’ æœ€æ–°åˆ†ææ™‚é–“ï¼š${analysis.fixTime}\n`;
            content += `ğŸ“ åº§æ¨™ï¼š${analysis.coordinate}\n`;
            content += `ğŸ’¨ æœ€å¤§é¢¨é€Ÿï¼š${analysis.maxWindSpeed} m/s\n`;
            content += `ğŸ¯ æ–¹å‘ï¼š${analysis.movingDirection}\n`;
            content += `ğŸ§­ é€Ÿåº¦ï¼š${analysis.movingSpeed} km/h\n`;
            content += `ğŸˆ ä¸­å¿ƒæ°£å£“ï¼š${analysis.pressure} hPa\n`;
            content += `ğŸŒ€ é™£é¢¨ï¼š${analysis.maxGustSpeed} m/s\n`;
            const movement = analysis.movingPrediction?.find(p => p.lang === "zh-hant");
            if (movement) content += `ğŸ“¡ ç§»å‹•æè¿°ï¼š${movement.value}\n`;
            content += `\n`;
          }

          const pre = document.createElement("pre");
          pre.innerText = content;
          block.appendChild(pre);

          // å»ºç«‹å¯æ”¶åˆé æ¸¬è·¯å¾‘å€å¡Š
          if (forecastList.length > 0) {
            const details = document.createElement("details");
            const summary = document.createElement("summary");
            summary.textContent = "é æ¸¬è·¯å¾‘ï¼ˆé»æˆ‘å±•é–‹ / æ”¶åˆï¼‰";
            details.appendChild(summary);

            const forecastDiv = document.createElement("div");
            forecastDiv.className = "forecast-content";

            forecastList.forEach(f => {
              let fLine = `â± ${f.tau} å°æ™‚å¾Œ â†’ åº§æ¨™ï¼š${f.coordinate}ã€é¢¨é€Ÿï¼š${f.maxWindSpeed} m/sã€æ°£å£“ï¼š${f.pressure} hPaã€æ–¹å‘ï¼š${f.movingDirection}ã€é€Ÿåº¦ï¼š${f.movingSpeed} km/h\n`;
              if (f.radiusOf70PercentProbability) {
                fLine += `ã€€ã€€ğŸ“ 70% æ©Ÿç‡åŠå¾‘ï¼š${f.radiusOf70PercentProbability} km\n`;
              }
              if (f.circleOf15Ms?.radius) {
                fLine += `ã€€ã€€ğŸŒ¬ 15m/s é¢¨é€ŸåŠå¾‘ï¼š${f.circleOf15Ms.radius} km\n`;
              }
              const state = f.stateTransfers?.find(p => p.lang === "zh-hant");
              if (state) {
                fLine += `ã€€ã€€ğŸ§¾ é æ¸¬ç‹€æ…‹ï¼š${state.value}\n`;
              }
              forecastDiv.appendChild(document.createTextNode(fLine));
              forecastDiv.appendChild(document.createElement("br"));
            });

            details.appendChild(forecastDiv);
            block.appendChild(details);
          }

          output.appendChild(block);
        });
      })
      .catch((err) => {
        document.getElementById("output").innerText = "âŒ è¼‰å…¥éŒ¯èª¤ï¼š" + err.message;
        console.error(err);
      });
  </script>
</body>
</html>
